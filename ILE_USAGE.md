# ILE (Inline Logic Engine) 使用方法

## 推奨形式: __vars__と__messages__を使用

変数を設定して使用する場合、`__vars__`と`__messages__`形式を使用することを推奨します：

```json
{
  "__vars__": {
    "userName": "田中",
    "row_idx": "${rand:1:100}"
  },
  "__messages__": [
    {"type": "text", "text": "こんにちは、${userName}さん！"},
    {"type": "text", "text": "ラッキーナンバーは${row_idx}です✨"}
  ]
}
```

### 乱数の書式

`__vars__`内では、以下の2つの形式が使用できます：
- `${rand:1:100}` - コロン区切り形式（推奨）
- `${rand(1, 100)}` - 関数呼び出し形式

## 変数セット（set関数）の書式

### 正しい書式

`set`関数を使って変数をセットする場合、以下の書式を使用してください：

```json
[
  {
    "type": "text",
    "text": "${set(row_idx, rand(0, 10))}${row_idx}本日の診断を開始します。"
  },
  {
    "type": "text",
    "text": "${row_idx}がセットされました。"
  }
]
```

### 重要なポイント

1. **引数内の関数呼び出しは`${}`なしで記述**
   - ✅ 正しい: `${set(row_idx, rand(0, 10))}`
   - ✅ これも動作: `${set(row_idx, ${rand(0, 10)})}`（ネスト形式も対応）
   - 推奨: `${set(row_idx, rand(0, 10))}`（シンプルな形式）

2. **`set`関数の戻り値は空文字**
   - `${set(row_idx, rand(0, 10))}`は空文字に置換されます
   - そのため、`"${set(row_idx, rand(0, 10))}${row_idx}本日の診断を開始します。"`は
   - `"${row_idx}本日の診断を開始します。"`に変換され、さらに`row_idx`の値に置換されます

3. **変数はメッセージ配列全体で共有**
   - 最初のメッセージで`set`した変数は、後続のメッセージでも使用できます

### 使用例

#### 例1: 乱数で変数をセット

```json
[
  {
    "type": "text",
    "text": "${set(row_idx, rand(0, 10))}ランダムな数値: ${row_idx}"
  }
]
```

#### 例2: 複数のメッセージで変数を使用

```json
[
  {
    "type": "text",
    "text": "${set(userName, '田中')}${set(row_idx, rand(1, 100))}こんにちは、${userName}さん！"
  },
  {
    "type": "text",
    "text": "あなたのラッキーナンバーは${row_idx}です。"
  }
]
```

#### 例3: __vars__で事前定義

```json
{
  "__vars__": {
    "row_idx": "${rand(0, 10)}"
  },
  "__messages__": [
    {
      "type": "text",
      "text": "${row_idx}本日の診断を開始します。"
    },
    {
      "type": "text",
      "text": "${row_idx}がセットされました。"
    }
  ]
}
```

### 動作の流れ

1. メッセージ配列を先頭から順に処理
2. 各メッセージの文字列値を評価
3. `${set(key, value)}`が評価されると：
   - `value`が評価される（関数呼び出しの場合は実行される）
   - 変数コンテキストに`key = 評価されたvalue`が保存される
   - 式全体が空文字に置換される
4. 後続のメッセージで`${key}`を参照すると、セットされた値が使用される

### トラブルシューティング

**Q: `${set(row_idx, ${rand(0, 10)})}`が動作しない**
A: 引数内の関数呼び出しには`${}`を使わないでください。`${set(row_idx, rand(0, 10))}`が正しい形式です。

**Q: 変数が空文字になる**
A: `set`関数の第2引数が正しく評価されているか確認してください。関数呼び出しの場合は引数の形式を確認してください。

**Q: 変数が後続のメッセージで使えない**
A: メッセージ配列の順序を確認してください。変数をセットするメッセージが、その変数を使用するメッセージより前に来る必要があります。

