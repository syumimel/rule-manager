# トラブルシューティングガイド

## よくある問題と解決方法

### 1. 認証関連

#### Google認証が動作しない

**症状**: ログインボタンをクリックしても認証が完了しない

**解決方法**:
1. Supabase Dashboard > Authentication > Providers > Google を確認
2. Google OAuth認証情報が正しく設定されているか確認
3. リダイレクトURLが正しく設定されているか確認
   - `http://localhost:3000/auth/callback` (開発環境)
   - `https://your-domain.com/auth/callback` (本番環境)

#### セッションが切れる

**症状**: ログイン後、すぐにログアウトされる

**解決方法**:
1. ブラウザのCookie設定を確認
2. Supabaseのセッション設定を確認
3. ミドルウェアの設定を確認

### 2. データベース関連

#### マイグレーションエラー

**症状**: SQL実行時にエラーが発生する

**解決方法**:
1. SQLファイルの構文を確認
2. 既存のテーブルとの競合を確認
3. Supabase Dashboard > Database > Extensions で必要な拡張機能が有効か確認

#### RLSポリシーが機能しない

**症状**: データにアクセスできない、または他のユーザーのデータが見える

**解決方法**:
1. RLSポリシーが有効になっているか確認
2. ポリシーの条件を確認
3. ユーザーIDが正しく取得できているか確認

### 3. CSVアップロード関連

#### CSVのアップロードが失敗する

**症状**: アップロード時にエラーが発生する

**解決方法**:
1. ファイルサイズを確認（メモリ制限）
2. 文字コードを確認（UTF-8推奨）
3. 行数・列数の制限を確認（最大4000行、20列）
4. 必須列が存在するか確認

#### データが正しく保存されない

**症状**: アップロードは成功するが、データが表示されない

**解決方法**:
1. データベースの`rule_rows`テーブルを確認
2. 世代IDが正しく紐付いているか確認
3. RLSポリシーを確認

### 4. LINE連携関連

#### Webhookが受信されない

**症状**: LINEからメッセージを送信しても反応がない

**解決方法**:
1. LINE Developers Console > Webhook URL を確認
2. Webhookの利用が有効になっているか確認
3. Vercelのログを確認
4. 署名検証が正しく動作しているか確認

#### 返信が送信されない

**症状**: Webhookは受信されるが、返信が送信されない

**解決方法**:
1. Channel Access Tokenが正しく設定されているか確認
2. Reply APIのレスポンスを確認
3. メッセージテンプレートが正しく登録されているか確認
4. 事前コンパイル済みメッセージが存在するか確認

### 5. 画像関連

#### 画像がアップロードできない

**症状**: 画像アップロード時にエラーが発生する

**解決方法**:
1. Storageバケットが作成されているか確認
2. バケットの公開設定を確認
3. ファイルサイズ制限を確認（10MB以下）
4. ファイル形式を確認（JPEG、PNG、GIFのみ）

#### 画像が表示されない

**症状**: アップロードは成功するが、画像が表示されない

**解決方法**:
1. Storageバケットの公開設定を確認
2. URLが正しく生成されているか確認
3. CORS設定を確認

### 6. 占いタイプ・テンプレート関連

#### 占いタイプ定義の検証に失敗する

**症状**: JSON定義をアップロードしてもエラーになる

**解決方法**:
1. JSONの構文を確認
2. 必須フィールドがすべて含まれているか確認
3. `fortune_type_id`の形式を確認（英数字、アンダースコア、ハイフンのみ）
4. 計算関数のパスが正しいか確認

#### メッセージテンプレートのコンパイルに失敗する

**症状**: テンプレートをアップロードしてもコンパイルエラーになる

**解決方法**:
1. メッセージ数が4-5ブロックか確認
2. 画像IDが存在するか確認
3. 数値範囲が網羅されているか確認
4. JSONの構造を確認

### 7. パフォーマンス関連

#### レスポンスが遅い

**症状**: ページの読み込みやAPIの応答が遅い

**解決方法**:
1. データベースクエリを最適化
2. インデックスを確認
3. 不要なデータ取得を削減
4. キャッシュを活用

#### メモリエラー

**症状**: 大量のデータを処理するとメモリエラーが発生する

**解決方法**:
1. バッチ処理のサイズを調整
2. ストリーミング処理を検討
3. データのページネーションを実装

## デバッグ方法

### 1. ログの確認

- **Vercel**: Dashboard > Logs
- **Supabase**: Dashboard > Logs
- **ブラウザ**: Developer Tools > Console

### 2. データベースの確認

```sql
-- テーブルの確認
SELECT * FROM rules LIMIT 10;

-- RLSポリシーの確認
SELECT * FROM pg_policies WHERE tablename = 'rules';
```

### 3. 環境変数の確認

```bash
# ローカル環境
cat .env.local

# Vercel環境
vercel env ls
```

## サポート

問題が解決しない場合は、以下を確認してください：

1. エラーメッセージの全文
2. ログの内容
3. 環境変数の設定
4. データベースの状態

詳細な情報と共に、開発チームに問い合わせてください。



