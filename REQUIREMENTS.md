# 要件定義書

## プロジェクト概要

**システム名**: LINE公式アカウント占い提供システム  
**技術スタック**: Next.js / Supabase / GitHub / Vercel  
**目的**: 占いルール（CSV）を登録・来歴管理し、LINE公式のメッセンジャーAPI経由で占い結果を返信する

---

## 1. システム概要

### 1.1 提供価値

- 占い師が占いルール（GoogleSpreadSheet → CSV）をアップロードして管理できる
- クライアントはLINE公式のメッセージやり取りだけで占いを受けられる（原則Webページへ遷移しない）
- 占い結果は乱数型（カード）および生年月日計算型（数秘、算命学、四柱推命）に対応する

### 1.2 想定利用者

- **管理者（サービス運営者）**: 全データへのアクセス権限
- **占い師（複数名）**: 自分の管理対象（ルール・画像）にのみアクセス
  - **想定数**: 200人程度
- **クライアント（複数名）**: LINE経由で占いを受ける
  - **想定数**: 40,000人（LINE公式登録者）

### 1.3 技術アーキテクチャ

- **フロントエンド**: Next.js
- **バックエンド**: Next.js API Routes / Supabase Edge Functions
- **データベース**: Supabase (PostgreSQL)
- **ストレージ**: Supabase Storage
- **認証**: Google認証（Supabase Auth）
- **デプロイ**: Vercel
- **ソース管理**: GitHub
- **外部API**: LINE Messaging API

---

## 2. 対象範囲

### 2.1 今回実装（必須機能）

#### 2.1.1 認証・権限管理
- Google認証によるログイン
- 役割（運営者/占い師）に応じた権限制御
- 占い師ごとのデータ分離

#### 2.1.2 占いルール（CSV）管理
- CSVアップロード（GoogleSpreadSheetからダウンロードしたCSV）
- ファイル単位の来歴管理（最大6世代）
- 行単位のJSON変換・保存
- 世代管理（アップロード日時、アップロード者、件数、有効/無効）
- プレビュー・検証・エラー表示

#### 2.1.3 占い実行（LINE公式）
- 乱数型占い（タロット/オラクル）
- 生年月日計算型占い（数秘、算命学、四柱推命）
- 相性型占い（2人の生年月日入力）
- LINE内での入力取得（Webページ遷移なし）
- 占い結果の抽出ロジック
- LINE返信（JSON形式、吹き出し4〜5ブロック、画像含む）

#### 2.1.4 画像管理
- 画像のアップロード・管理（Supabase Storage）
- 占い師単位またはルール単位での紐付け
- LINEイメージマップメッセージ対応
  - 特定のPathを起点として、大きさの異なる画像データを拡張子なしで5つ配置
  - 必要に応じてSupabase Edge Functionsを検討

#### 2.1.5 ログ管理
- LINEのやり取り（受信・返信）の記録
- 処理結果・エラーログの記録

### 2.2 将来実装（今回は対象外・設計で考慮）

- 個別鑑定の予約管理
- Stripe決済
- LINEチャットUIによる占い（Web）
- LINEボイス占い
- 複数占い師×複数クライアントのマルチテナント運用強化

---

## 3. 機能要件詳細

### 3.1 認証・権限

#### 3.1.1 認証方式
- **認証プロバイダ**: Google認証（Supabase Auth経由）
- **ログイン画面**: Next.jsで実装
- **セッション管理**: Supabase Authのセッション管理を利用

#### 3.1.2 権限モデル
- **運営者（admin）**
  - 全占い師のデータにアクセス可能
  - システム設定の変更が可能
- **占い師（fortune_teller）**
  - 自分のルール・画像にのみアクセス可能
  - 他の占い師のデータにはアクセス不可

#### 3.1.3 データ分離
- データベースレベルでRLS（Row Level Security）を実装
- 占い師IDをキーとしてデータを分離

---

### 3.2 占いルール（CSV）管理

#### 3.2.1 CSV仕様
- **取り込み元**: GoogleSpreadSheetからダウンロードしたCSV
- **1ファイルあたりの制約**:
  - 最大行数: 4000行
  - 最大列数: 20列
  - 平均想定: 200行
- **カラム書式**: 列ごとに異なる形式を許容
- **パターン数**: 最大50パターン（テンプレート/型）

#### 3.2.2 CSV取り込み処理
1. **アップロード**
   - ファイル選択・アップロード
   - 文字コード検出・変換（UTF-8に統一）
   - ファイル名・メタデータの取得

2. **検証**
   - 行数チェック（4000行以下）
   - 列数チェック（20列以下）
   - 必須列の存在確認
   - データ型の検証（必要に応じて）

3. **エラー処理**
   - 検証エラー時は詳細を表示
   - エラー時は保存しない
   - エラーログを記録

4. **データ変換**
   - CSVの各行をJSON形式に変換
   - 行単位でデータベースに保存
   - 世代IDを付与して紐付け

#### 3.2.3 来歴管理（最大6世代）

**世代管理の仕様**:
- CSVは「ファイル単位」で来歴を保持
- 同一ルール名（または同一カテゴリ）に対し、最大6世代まで保持
- 7世代目以降は、最も古い世代を自動的に削除（またはアーカイブ）
- 各世代の属性:
  - アップロード日時
  - アップロード者（占い師ID）
  - 件数（行数）
  - 有効/無効フラグ
  - 世代番号（1〜6）

**世代管理のロジック**:
```
1. 新規アップロード時
   - 同一ルール名の既存世代数を確認
   - 6世代未満の場合: 新規世代として追加
   - 6世代の場合: 最も古い世代を削除してから新規世代を追加

2. 世代の有効化/無効化
   - 複数世代が存在する場合、有効な世代は1つのみ（または複数可）
   - 無効化された世代は占い実行時に参照されない
```

#### 3.2.4 データ保存形式

**データベース設計（概要）**:
- **rulesテーブル**: ルールファイルのメタ情報
  - id, name, category, fortune_teller_id, created_at, updated_at
- **rule_generationsテーブル**: 世代情報
  - id, rule_id, generation_number, uploaded_at, uploaded_by, row_count, is_active, is_archived
- **rule_rowsテーブル**: 行単位のデータ（JSON形式）
  - id, generation_id, row_number, data (JSONB), created_at

#### 3.2.5 ルールの確認（閲覧）

**機能**:
- 世代一覧の表示（最大6世代）
- 世代選択による内容の一覧表示
- 検索・フィルタ機能
- 主要カラムの表示切替（20カラムすべてを固定表示しない）
- プレビュー（先頭N行）と件数サマリの表示

---

### 3.3 占い実行（LINE公式）

#### 3.3.1 占いの種類

**1. 乱数型占い**
- タロット/オラクルのようにカードを引く
- 乱数生成によりルール行データから該当データを抽出
- 例: タロットカード、オラクルカード

**2. 生年月日計算型占い**
- 数秘術: 生年月日から数値を計算
- 算命学: 生年月日から運勢を算出
- 四柱推命: 生年月日時から命式を算出
- 計算値によりルール行データから該当データを抽出

**3. 相性型占い**
- 2人の生年月日を入力
- 数秘/四柱推命の相性を計算
- 計算値によりルール行データから該当データを抽出

#### 3.3.2 入力取得（LINE内完結）

**入力フロー**:
1. ユーザーが占いを開始（キーワードまたはボタン）
2. 占いの種類を選択
3. 生年月日を入力（必要に応じて）
   - 許容形式: YYYYMMDD / YYYY-MM-DD / YYYY/MM/DD
   - 入力エラー時は再入力を促す
4. 相性占いの場合は2人目の生年月日も取得

**実装方針**:
- LINEのメッセージやり取りの中で完結
- 原則Webページへ誘導しない
- 会話フローで案内する

#### 3.3.3 抽出ロジック

**処理フロー**:
1. 占いの種類を判定
2. 有効なルール世代を特定
3. 乱数または生年月日計算値を生成（数値化）
4. ルール行データから該当データを抽出
5. 抽出したデータを数値化（結果値）
6. 数値に対する返信メッセージを事前コンパイル済みDBから取得
7. 返信用JSONを生成（動的生成は行わない）

**数値化の仕様**:
- 占い結果は必ず数値（または数値の組み合わせ）に変換する
- 例:
  - **乱数型**: 1〜Nの整数値（Nはルール行数）
  - **数秘術**: 1〜9の数値（生年月日から計算）
  - **四柱推命**: 干支・五行の組み合わせを数値化（例: 天干×10 + 地支）

**計算ロジックの外部化**:
- 計算ロジックはJSON定義ファイルで指定
- 外部関数（Edge FunctionsまたはAPI）として呼び出し可能
- 新しい占いタイプを追加する際は、定義ファイルと計算関数のみ追加

**抽出ロジックの例**:
- **乱数型**: `Math.floor(Math.random() * rowCount) + 1` で行番号を決定
- **数秘術**: 生年月日の各桁を合計して1桁になるまで計算 → その値で行を抽出
- **四柱推命**: 生年月日時から干支・五行を算出 → 該当する行を抽出

#### 3.3.4 返信形式（事前コンパイル方式）

**基本方針**:
- **動的生成禁止**: 占い結果の返信メッセージは動的に生成しない
- **事前コンパイル**: 返信メッセージは事前にJSONで定義し、DBに保存
- **数値マッピング**: 占い結果の数値に対応する返信メッセージを事前に定義
- **事前検証**: アップロード時に返信メッセージの妥当性を検証

**返信メッセージの管理**:
1. **定義ファイル（JSON）**:
   - 占いタイプごとに返信メッセージのテンプレートを定義
   - 数値範囲ごとのメッセージ内容を定義
   - 表示形式（テキスト、画像、イメージマップ）を定義

2. **DB保存**:
   - 定義ファイルをアップロード時にDBに保存
   - `fortune_message_templates`テーブルに保存
   - 数値とメッセージのマッピングを事前に構築

3. **返信生成**:
   - 占い結果の数値を取得
   - 数値に対応する事前定義済みメッセージをDBから取得
   - メッセージをそのまま返信（動的加工なし）

**LINE返信メッセージの構成**:
- **形式**: JSON形式（LINE Messaging APIのReply API）
- **吹き出し数**: 4〜5ブロック（複数メッセージ）
- **メッセージ種別**:
  - テキストメッセージ
  - 画像メッセージ
  - イメージマップメッセージ（必要に応じて）

**返信JSONの例**:
```json
{
  "replyToken": "...",
  "messages": [
    {
      "type": "text",
      "text": "占い結果です..."
    },
    {
      "type": "image",
      "originalContentUrl": "https://...",
      "previewImageUrl": "https://..."
    },
    {
      "type": "text",
      "text": "詳細は..."
    }
  ]
}
```

**カテゴリ別対応**:
- 恋愛、人間関係、仕事運など、カテゴリ別の文面を返せる
- ルールデータにカテゴリ情報を含める
- カテゴリごとに返信メッセージテンプレートを定義

#### 3.3.5 LINE Webhook処理

**処理フロー**:
1. LINE Webhookを受信
2. リクエストの正当性を検証（署名検証）
3. イベントタイプを判定（メッセージ、フォロー、アンフォローなど）
4. 占い実行処理を呼び出し
5. Reply APIで返信
6. ログを記録

**エラーハンドリング**:
- Webhook検証失敗時はエラーログを記録
- 占い実行エラー時はユーザーにエラーメッセージを返信

---

### 3.4 画像管理

#### 3.4.1 画像アップロード

**機能**:
- 画像ファイルのアップロード（Supabase Storage）
- ファイル形式: JPEG, PNG, GIF（必要に応じて）
- ファイルサイズ制限: 10MB以下（LINE Messaging APIの制限に準拠）

**保存先**:
- Supabase Storageのバケット: `fortune-images`
- パス構造: `{fortune_teller_id}/{rule_id}/{image_id}/`

#### 3.4.2 画像の紐付け

**紐付け方式**:
- **占い師単位**: 占い師が所有する画像
- **ルール単位**: 特定のルールに紐付く画像
- **行単位**: 特定のルール行に紐付く画像（将来拡張）

**データベース設計**:
- **imagesテーブル**:
  - id, fortune_teller_id, rule_id (nullable), name, file_path, url, created_at

#### 3.4.3 LINEイメージマップメッセージ対応

**要件**:
- 画像のデータを特定のPathを起点として、その配下に大きさの異なる画像データを拡張子なしで5つ置く必要がある

**実装方針**:
1. **画像リサイズ処理**
   - アップロード時に複数サイズを生成（例: 1040x1040, 700x700, 460x460, 300x300, 240x240）
   - または、Supabase Edge Functionsで動的にリサイズ

2. **パス構造**:
   ```
   {base_path}/{image_id}/
     - 1040 (拡張子なし)
     - 700
     - 460
     - 300
     - 240
   ```

3. **Edge Functionsの検討**:
   - リクエスト時に動的にリサイズする場合
   - または、アップロード時に一括リサイズ

**実装方法（案）**:
- **方法1**: アップロード時に5つのサイズを生成して保存
- **方法2**: Edge Functionsで動的にリサイズ（キャッシュ付き）

---

### 3.5 占い機能の拡張性（プラグイン機構）

#### 3.5.1 機能追加の仕組み

**基本方針**:
- プログラム変更なしに占いのルール、内容、表示形式を追加可能
- JSON定義ファイルと計算ロジックの外部呼び出しで対応

**実装方式**:

1. **占いタイプ定義（JSON）**:
   ```json
   {
     "fortune_type_id": "numerology",
     "name": "数秘術",
     "description": "生年月日から数値を計算",
     "calculation_function": "edge-functions/calculate-numerology",
     "input_format": {
       "birth_date": "YYYYMMDD"
     },
     "output_format": {
       "result_value": "number (1-9)"
     },
     "message_template_id": "numerology-template-001"
   }
   ```

2. **計算ロジックの外部化**:
   - 計算ロジックはSupabase Edge Functionsまたは外部APIとして実装
   - 定義ファイルで関数名を指定
   - 新しい占いタイプは関数を追加するだけで対応

3. **表示形式の定義**:
   - 返信メッセージの形式（テキスト、画像、イメージマップ）をJSONで定義
   - テンプレートIDで管理画面から選択可能

4. **管理画面での登録**:
   - 占いタイプ定義JSONをアップロード
   - 計算関数のURL/パスを指定
   - 返信メッセージテンプレートを紐付け
   - 事前検証を実行

**データベース設計**:
- **fortune_typesテーブル**:
  - id, name, description, definition (JSONB), calculation_function_path, is_active, created_at
- **fortune_message_templatesテーブル**:
  - id, fortune_type_id, result_value, message_config (JSONB), created_at

#### 3.5.2 返信メッセージの事前コンパイル

**事前コンパイルの流れ**:
1. 占いタイプ定義をアップロード
2. 返信メッセージテンプレート（JSON）をアップロード
3. 数値範囲ごとのメッセージ内容を定義
4. システムが事前に検証・コンパイル
5. DBに保存（`fortune_message_templates`テーブル）

**返信メッセージテンプレートの例**:
```json
{
  "fortune_type_id": "numerology",
  "templates": [
    {
      "result_value": 1,
      "messages": [
        {
          "type": "text",
          "text": "あなたの数秘は1です。リーダーシップの数字です。"
        },
        {
          "type": "image",
          "image_id": "numerology-1"
        },
        {
          "type": "text",
          "text": "今月の運勢は..."
        }
      ]
    },
    {
      "result_value": 2,
      "messages": [...]
    }
  ]
}
```

**事前検証**:
- テンプレートJSONの形式チェック
- 数値範囲の網羅性チェック（全数値に対応するメッセージがあるか）
- メッセージブロック数のチェック（4〜5ブロック）
- 画像IDの存在確認

---

### 3.6 ログ管理

#### 3.6.1 LINEやり取りログ

**記録内容**:
- 受信メッセージ（ユーザーID、メッセージ内容、受信日時）
- 返信メッセージ（返信内容、返信日時、成功/失敗）
- 占い実行結果（占い種類、抽出されたルール行、計算値、結果数値など）

**データベース設計**:
- **line_interactionsテーブル**:
  - id, user_id, event_type, message_content, reply_content, fortune_type, rule_id, generation_id, result_value, created_at

#### 3.6.2 処理ログ

**記録内容**:
- CSV取り込み処理のログ（成功/失敗、エラー内容）
- 画像アップロードのログ
- 占いタイプ定義のアップロードログ
- 返信メッセージテンプレートのアップロードログ
- システムエラーログ

---

## 4. 非機能要件

### 4.1 性能・制約

- **CSV取り込み**: 最大4000行/20列に耐える（目標: 10秒以内）
- **LINE返信**: 利用者体感で遅延が大きくならない（目標: 3秒以内）
- **画像アップロード**: 10MB以下のファイルを30秒以内に処理
- **スケール要件**:
  - 占い師数: 200人程度
  - LINE公式登録者: 40,000人
  - 1日のトランザクション: 20,000メッセージ
  - ピーク時: 1秒あたり約5〜10リクエストを想定

### 4.2 可用性・運用

- **デプロイ**: Vercelにデプロイされ、GitHub連携で更新できる
- **ログ**: 障害時に原因追跡できるログを確保（アプリログ/処理結果）
- **監視**: エラー率、レスポンス時間の監視

### 4.3 セキュリティ

- **認証**: 認証済みユーザーのみ管理画面へアクセスできる
- **データ分離**: 占い師ごとのデータ隔離（RLS実装）
- **Webhook検証**: LINEのWebhookは正当性検証を行う（署名検証）
- **APIキー管理**: 環境変数で管理（Vercelの環境変数設定）

### 4.4 拡張性

- **ルールパターン**: 最大50パターン追加に対応できる設計
- **モジュール分割**: 機能はモジュール単位で分割して管理
- **将来機能**: 予約・決済・ボイス占いを追加できる構造
- **機能追加の柔軟性**: 
  - 占いのルール、内容、表示形式をプログラム変更なしに追加可能
  - JSON定義ファイルと計算ロジックの外部呼び出しで対応
  - プラグイン的な拡張機構を実装

---

## 5. 画面要件（管理画面）

### 5.1 ダッシュボード

**表示内容**:
- 有効ルール数
- 最新アップロード（直近5件）
- エラー状況（直近のエラーログ）
- 統計情報（アップロード総数、画像総数など）

### 5.2 占いルール管理

#### 5.2.1 アップロード画面
- ファイル選択
- ルール名・カテゴリの入力
- アップロード実行
- 進捗表示
- エラー表示

#### 5.2.2 世代一覧画面
- ルール一覧（ルール名、カテゴリ、最新世代番号、有効/無効）
- 世代一覧（最大6世代）
  - 世代番号、アップロード日時、アップロード者、件数、有効/無効
- 世代選択による詳細表示

#### 5.2.3 世代詳細画面
- プレビュー（先頭N行）
- 件数サマリ
- 有効化/無効化ボタン
- 削除ボタン（確認付き）
- 検索・フィルタ機能
- 主要カラムの表示切替

### 5.3 画像管理

#### 5.3.1 アップロード画面
- ファイル選択（複数選択可）
- ルールへの紐付け（オプション）
- アップロード実行
- 進捗表示

#### 5.3.2 一覧/検索画面
- 画像一覧（サムネイル表示）
- 検索機能（名前、ルール名で検索）
- 使用先の確認（どのルール/返信に紐付くか）
- 削除機能

### 5.4 占いタイプ管理

#### 5.4.1 占いタイプ定義画面
- 占いタイプ一覧
- 新規登録（JSON定義ファイルのアップロード）
- 編集・削除
- 有効化/無効化
- 計算関数の設定

#### 5.4.2 返信メッセージテンプレート画面
- テンプレート一覧（占いタイプ別）
- 新規登録（JSONテンプレートファイルのアップロード）
- 編集・削除
- 事前検証実行
- プレビュー機能

### 5.5 LINE連携設定

#### 5.5.1 設定画面
- Messaging API設定
  - Channel ID
  - Channel Secret
  - Webhook URL（表示のみ）
- LINEログイン認証設定
  - チャンネルID
  - チャンネルシークレット
- 設定の保存・更新
- Webhook検証テスト

---

## 6. 外部連携要件

### 6.1 LINE Messaging API

**機能**:
- Webhook受信（Next.js API Route）
- Reply APIでの返信（JSON形式メッセージ）
- 署名検証（リクエストの正当性確認）

**設定項目**:
- Channel ID
- Channel Secret
- Webhook URL: `https://{domain}/api/line/webhook`

### 6.2 Google認証

**機能**:
- Supabase Auth経由でGoogle認証を実装
- ログイン後のセッション管理

### 6.3 Supabase

**利用サービス**:
- **PostgreSQL**: データベース（ルール、画像、ログ）
- **Storage**: 画像ファイルの保存
- **Auth**: Google認証
- **Edge Functions**: 画像リサイズ処理（必要に応じて）

### 6.4 GitHub / Vercel

**機能**:
- GitHubでソース管理
- Vercelにデプロイ（GitHub連携で自動デプロイ）

---

## 7. データベース設計（概要）

### 7.1 テーブル一覧

1. **users** (Supabase Auth)
   - id, email, role (admin/fortune_teller), created_at

2. **rules**
   - id, name, category, fortune_teller_id, created_at, updated_at

3. **rule_generations**
   - id, rule_id, generation_number (1-6), uploaded_at, uploaded_by, row_count, is_active, is_archived, created_at

4. **rule_rows**
   - id, generation_id, row_number, data (JSONB), created_at

5. **images**
   - id, fortune_teller_id, rule_id (nullable), name, file_path, url, created_at, updated_at

6. **line_interactions**
   - id, user_id (LINE), event_type, message_content, reply_content, fortune_type, rule_id, generation_id, created_at

7. **line_settings**
   - id, fortune_teller_id, channel_id, channel_secret, created_at, updated_at

8. **fortune_types**
   - id, fortune_teller_id, name, description, definition (JSONB), calculation_function_path, is_active, created_at, updated_at

9. **fortune_message_templates**
   - id, fortune_type_id, result_value, message_config (JSONB), created_at, updated_at

### 7.2 RLS（Row Level Security）ポリシー

- **rules**: 占い師は自分のルールのみアクセス可能
- **rule_generations**: ルールに紐付くため、ルールのRLSを継承
- **rule_rows**: 世代に紐付くため、世代→ルールのRLSを継承
- **images**: 占い師は自分の画像のみアクセス可能
- **line_settings**: 占い師は自分の設定のみアクセス可能
- **fortune_types**: 占い師は自分の占いタイプ定義のみアクセス可能
- **fortune_message_templates**: 占いタイプに紐付くため、占いタイプのRLSを継承

---

## 8. 開発要件

### 8.1 モジュール分割

**機能モジュール**:
1. **認証モジュール** (`modules/auth`)
   - Google認証
   - 権限チェック
   - セッション管理

2. **CSV取込モジュール** (`modules/csv-import`)
   - CSVアップロード
   - 検証・変換
   - エラー処理

3. **来歴管理モジュール** (`modules/generation`)
   - 世代管理（最大6世代）
   - 世代の有効化/無効化
   - 自動削除処理

4. **占い実行モジュール** (`modules/fortune`)
   - 乱数生成
   - 生年月日計算（外部関数呼び出し）
   - ルール行抽出
   - 結果の数値化
   - 事前コンパイル済みメッセージ取得

5. **占いタイプ管理モジュール** (`modules/fortune-type`)
   - 占いタイプ定義の登録・管理
   - 計算ロジックの外部呼び出し
   - 返信メッセージテンプレートの管理
   - 事前コンパイル・検証

6. **画像管理モジュール** (`modules/image`)
   - 画像アップロード
   - リサイズ処理
   - イメージマップ対応

7. **LINE返信モジュール** (`modules/line`)
   - Webhook受信
   - 事前コンパイル済みメッセージ取得
   - 返信JSON生成（動的生成なし）
   - Reply API呼び出し

8. **ログモジュール** (`modules/log`)
   - LINEやり取りログ
   - 処理ログ

### 8.2 タスク管理

- 機能単位で完結する粒度でタスクを分割
- 各モジュールは独立して開発・テスト可能

### 8.3 既存プロジェクトへの追加

- 「オオム返し」プロジェクトへ追加する前提
- 影響範囲をモジュール境界で限定
- 既存機能への影響を最小化

---

## 9. 受け入れ条件（動作確認）

### 9.1 CSV管理
- [ ] CSVをアップロードし、世代が作成される
- [ ] 最大6世代まで管理できる
- [ ] 7世代目をアップロードすると、最も古い世代が削除される
- [ ] アップロードしたデータが行単位で保存される
- [ ] 世代を切り替えて参照できる

### 9.2 占い実行
- [ ] 乱数型占いを実行できる（少なくとも1種類）
- [ ] 生年月日型占いを実行できる（少なくとも1種類）
- [ ] 返信が4〜5ブロックで返る
- [ ] 画像を含めた返信ができる
- [ ] 占い結果が数値化される
- [ ] 事前コンパイル済みメッセージが返信される（動的生成なし）

### 9.6 占いタイプ管理
- [ ] 占いタイプ定義をJSONで登録できる
- [ ] 計算ロジックを外部関数として呼び出せる
- [ ] 返信メッセージテンプレートを事前に登録できる
- [ ] 事前検証が実行できる
- [ ] プログラム変更なしに新しい占いタイプを追加できる

### 9.3 データ分離
- [ ] 占い師を複数作成できる
- [ ] 占い師Aは自分のルール・画像にのみアクセスできる
- [ ] 占い師Aは占い師Bのデータにアクセスできない

### 9.4 画像管理
- [ ] 画像をアップロードできる
- [ ] 画像をルールに紐付けられる
- [ ] LINE返信で画像を使用できる
- [ ] イメージマップメッセージに対応できる（必要に応じて）

### 9.5 認証・権限
- [ ] Google認証でログインできる
- [ ] 運営者は全データにアクセスできる
- [ ] 占い師は自分のデータにのみアクセスできる

---

## 10. 技術的な実装方針

### 10.1 プロジェクト構造（案）

```
rule-manager/
├── app/                    # Next.js App Router
│   ├── (auth)/            # 認証関連ページ
│   ├── (dashboard)/       # 管理画面
│   │   ├── dashboard/
│   │   ├── rules/
│   │   ├── images/
│   │   └── settings/
│   └── api/               # API Routes
│       └── line/
│           └── webhook/
├── modules/               # 機能モジュール
│   ├── auth/
│   ├── csv-import/
│   ├── generation/
│   ├── fortune/
│   ├── fortune-type/      # 占いタイプ管理
│   ├── image/
│   ├── line/
│   └── log/
├── config/                # 設定ファイル
│   ├── fortune-types/     # 占いタイプ定義JSON（サンプル）
│   └── message-templates/ # 返信メッセージテンプレート（サンプル）
├── lib/                   # 共通ライブラリ
│   ├── supabase/
│   └── utils/
├── supabase/              # Supabase設定
│   ├── migrations/        # データベースマイグレーション
│   └── functions/         # Edge Functions
└── public/                # 静的ファイル
```

### 10.2 主要技術スタック

- **Next.js**: 14+ (App Router)
- **TypeScript**: 型安全性の確保
- **Supabase**: データベース・ストレージ・認証
- **Tailwind CSS**: UIスタイリング
- **Zod**: バリデーション
- **React Hook Form**: フォーム管理

### 10.3 環境変数

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# LINE
LINE_CHANNEL_ID=
LINE_CHANNEL_SECRET=

# Google OAuth (Supabase経由)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
```

---

## 11. 実装優先順位（案）

### Phase 1: 基盤構築
1. プロジェクトセットアップ（Next.js + Supabase）
2. 認証機能（Google認証）
3. データベース設計・マイグレーション
4. 基本UI（ダッシュボード）

### Phase 2: CSV管理
1. CSVアップロード機能
2. 検証・エラー処理
3. 行単位のJSON保存
4. 世代管理（最大6世代）
5. ルール閲覧機能

### Phase 3: 占いタイプ管理
1. 占いタイプ定義の登録機能
2. 計算ロジックの外部呼び出し機構
3. 返信メッセージテンプレートの登録機能
4. 事前コンパイル・検証機能

### Phase 4: LINE連携
1. LINE Webhook受信
2. 占い実行ロジック（乱数型・生年月日型）
3. 結果の数値化
4. 事前コンパイル済みメッセージ取得
5. 返信JSON生成（動的生成なし）
6. Reply API実装
7. ログ記録

### Phase 5: 画像管理
1. 画像アップロード（Supabase Storage）
2. 画像一覧・検索
3. LINE返信での画像使用
4. イメージマップメッセージ対応（必要に応じて）

### Phase 6: 運用機能
1. エラーログ確認
2. 統計情報表示
3. 設定画面
4. テスト・デバッグ

---

## 12. 注意事項・制約事項

### 12.1 LINE Messaging APIの制約
- 画像ファイルサイズ: 10MB以下
- 返信メッセージ数: 5件まで
- Webhook検証: 署名検証が必須

### 12.2 Supabase Storageの制約
- ファイルサイズ制限: デフォルト50MB（設定で変更可能）
- ストレージ容量: プランに依存

### 12.3 データ保持
- 世代管理: 最大6世代まで保持
- 7世代目以降: 自動削除（またはアーカイブ）
- 削除ポリシー: 運用ポリシーに従う

### 12.4 機能拡張の制約
- 占いタイプ追加: JSON定義ファイルと計算関数のみで対応
- 返信メッセージ: 事前コンパイル方式（動的生成禁止）
- 計算ロジック: 外部関数（Edge Functions/API）として実装
- 表示形式: JSON定義で指定（プログラム変更不要）

### 12.5 スケール要件
- **占い師数**: 200人程度
- **LINE登録者数**: 40,000人
- **1日のトランザクション**: 20,000メッセージ
- **ピーク時負荷**: 1秒あたり約5〜10リクエスト
- **対応方針**:
  - Vercelの自動スケーリングを活用
  - データベース接続プールの最適化
  - キャッシュ戦略の検討（返信メッセージなど）
  - 非同期処理の活用（ログ記録など）

---

## 13. 参考資料

- [LINE Messaging API ドキュメント](https://developers.line.biz/ja/docs/messaging-api/)
- [Supabase ドキュメント](https://supabase.com/docs)
- [Next.js ドキュメント](https://nextjs.org/docs)
- [Vercel ドキュメント](https://vercel.com/docs)

---

以上

